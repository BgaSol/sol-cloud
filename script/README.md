# éƒ¨ç½²è„šæœ¬

# åˆ†å±‚éƒ¨ç½²å·®å¼‚åŒæ­¥å·¥å…·

è¿™æ˜¯ä¸€å¥—ç”¨äº Spring Boot åˆ†å±‚éƒ¨ç½²çš„å·®å¼‚åŒæ­¥å·¥å…·ï¼ŒåŒ…å«ç°åœºæ•°æ®æ”¶é›†å’Œå·®å¼‚åŒ…ç”Ÿæˆä¸¤ä¸ªæ ¸å¿ƒè„šæœ¬ã€‚

## æ¦‚è¿°

è¯¥å·¥å…·é›†ä¸»è¦ç”¨äºè§£å†³ä»¥ä¸‹åœºæ™¯ï¼š
- **ç°åœºç¯å¢ƒ**ï¼šè¿è¡Œç”Ÿäº§æœåŠ¡ï¼Œéœ€è¦æ”¶é›†å½“å‰éƒ¨ç½²çŠ¶æ€
- **å¼€å‘ç¯å¢ƒ**ï¼šåŸºäºç°åœºæ”¶é›†çš„æ•°æ®ï¼Œç”Ÿæˆæœ€å°åŒ–çš„å·®å¼‚æ›´æ–°åŒ…
- **å·®å¼‚éƒ¨ç½²**ï¼šä»…æ›´æ–°å˜åŒ–çš„ä¾èµ–å’Œä¸šåŠ¡ä»£ç ï¼Œå‡å°‘éƒ¨ç½²é£é™©å’Œæ—¶é—´

## å·¥å…·ç»„æˆ

### 1. collect-layers.sh - ç°åœºæ”¶é›†è„šæœ¬
ç”¨äºåœ¨ç°åœºç¯å¢ƒæ”¶é›†å„æ¨¡å—çš„ `layers.idx` æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶è®°å½•äº† Spring Boot åˆ†å±‚æ‰“åŒ…çš„ä¾èµ–ä¿¡æ¯ã€‚

### 2. compare-sync.sh - å·®å¼‚ç”Ÿæˆè„šæœ¬  
åŸºäºæ”¶é›†çš„ç°åœºæ•°æ®ï¼Œåœ¨å¼€å‘ç¯å¢ƒç”Ÿæˆå·®å¼‚åº”ç”¨åŒ…ï¼ŒåŒ…å«éœ€è¦æ›´æ–°çš„ä¾èµ–å’Œä¸šåŠ¡ä»£ç ã€‚

---

## collect-layers.sh è¯¦ç»†è¯´æ˜

### åŠŸèƒ½æè¿°
è‡ªåŠ¨å‘ç°å¹¶æ”¶é›†æ‰€æœ‰æ¨¡å—çš„ `layers.idx` æ–‡ä»¶ï¼Œç”¨äºåç»­çš„å·®å¼‚åˆ†æã€‚

### ä½¿ç”¨æ–¹æ³•
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
./script/collect-layers.sh
```

### å·¥ä½œæµç¨‹
1. **è‡ªåŠ¨å‘ç°æ¨¡å—**ï¼šæ‰«æ `docker/output/server` è·¯å¾„ä¸‹çš„æ‰€æœ‰æ¨¡å—
2. **æ”¶é›† layers.idx**ï¼šæŸ¥æ‰¾æ¯ä¸ªæ¨¡å—çš„ `application/BOOT-INF/layers.idx` æ–‡ä»¶
3. **åˆ›å»ºæ”¶é›†åŒ…**ï¼šå°†æ‰€æœ‰æ”¶é›†çš„æ–‡ä»¶æ‰“åŒ…æˆ `layers-collection-{timestamp}.tar.gz`
4. **è¾“å‡ºç»“æœ**ï¼šå‹ç¼©åŒ…ä¿å­˜åœ¨ `script/collect/` ç›®å½•ä¸‹

### è¾“å‡ºç»“æ„
```
script/collect/
â””â”€â”€ layers-collection-20250918-093742.tar.gz
    â””â”€â”€ layers-collection-20250918-093742/
        â”œâ”€â”€ module1/
        â”‚   â””â”€â”€ layers.idx
        â”œâ”€â”€ module2/
        â”‚   â””â”€â”€ layers.idx
        â””â”€â”€ ...
```

### æ‰§è¡Œç¤ºä¾‹
```bash
$ ./script/collect-layers.sh

ğŸš€ å¼€å§‹æ”¶é›†ç°åœº layers.idx æ–‡ä»¶
ğŸ“˜ é¡¹ç›®æ ¹ç›®å½•: /path/to/sol-cloud
ğŸ“˜ ä¸´æ—¶ç›®å½•: /path/to/script/layers-collection-20250918-093742
ğŸ“˜ å‹ç¼©åŒ…ç›®å½•: /path/to/script/collect

ğŸš€ è‡ªåŠ¨å‘ç°æ¨¡å—
ğŸ“˜ æ‰«æ: docker/output/server
âœ… å‘ç°æ¨¡å—: web-system-8081
âœ… å‘ç°æ¨¡å—: web-file-8082
âœ… å‘ç°æ¨¡å—: gateway-9527

ğŸš€ æ”¶é›† layers.idx æ–‡ä»¶
âœ… æ”¶é›†: web-system-8081/layers.idx (2.1K)
âœ… æ”¶é›†: web-file-8082/layers.idx (1.8K)
âœ… æ”¶é›†: gateway-9527/layers.idx (1.5K)

ğŸš€ åˆ›å»ºå‹ç¼©åŒ…
âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: layers-collection-20250918-093742.tar.gz
ğŸ“˜ æ–‡ä»¶å¤§å°: 8.2K

ğŸš€ æ”¶é›†å®Œæˆ
ğŸ“˜ å‹ç¼©åŒ…ä½ç½®: script/collect/layers-collection-20250918-093742.tar.gz
ğŸ“˜ æ”¶é›†æ¨¡å—æ•°: 3
ğŸ“˜ æ‰§è¡Œè€—æ—¶: 2ç§’
âœ… ç°åœºæ”¶é›†ä»»åŠ¡å®Œæˆï¼
```

---

## compare-sync.sh è¯¦ç»†è¯´æ˜

### åŠŸèƒ½æè¿°
åŸºäºç°åœºæ”¶é›†çš„ `layers.idx` æ–‡ä»¶ï¼Œç”Ÿæˆå·®å¼‚åº”ç”¨åŒ…ï¼ŒåŒ…å«éœ€è¦æ›´æ–°çš„ä¾èµ–jaræ–‡ä»¶å’Œä¸šåŠ¡ä»£ç ã€‚

### ä½¿ç”¨æ–¹æ³•
```bash
# åŸºæœ¬ç”¨æ³•
./script/compare-sync.sh --layers-collection <æ”¶é›†ç›®å½•è·¯å¾„>

# å¸¦å¯é€‰å‚æ•°
./script/compare-sync.sh --layers-collection <æ”¶é›†ç›®å½•è·¯å¾„> \
  [--spring-boot-upgraded] \
  [--has-snapshot] \
  [--modules module1,module2]
```

### å‚æ•°è¯´æ˜
| å‚æ•° | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| `--layers-collection` | âœ… | ç°åœºæ”¶é›†çš„è§£å‹ç›®å½•è·¯å¾„ |
| `--spring-boot-upgraded` | âŒ | Spring Boot ç‰ˆæœ¬å·²å‡çº§æ ‡å¿— |
| `--has-snapshot` | âŒ | åŒ…å« SNAPSHOT ç‰ˆæœ¬ä¾èµ–æ ‡å¿— |
| `--modules` | âŒ | æŒ‡å®šå¤„ç†ç‰¹å®šæ¨¡å—ï¼Œç”¨é€—å·åˆ†éš” |

### å·¥ä½œæµç¨‹
1. **è§£æå‚æ•°**ï¼šéªŒè¯æ”¶é›†ç›®å½•å’Œå¯é€‰å‚æ•°
2. **å‘ç°æ¨¡å—**ï¼šæ‰«ææ”¶é›†ç›®å½•ä¸­çš„æ‰€æœ‰æ¨¡å—
3. **æ¯”è¾ƒå·®å¼‚**ï¼šå¯¹æ¯”ç°åœºå’Œæœ¬åœ°çš„ `layers.idx` æ–‡ä»¶
4. **ç”Ÿæˆå·®å¼‚åŒ…**ï¼š
   - å¤åˆ¶å˜æ›´çš„ä¾èµ–jaræ–‡ä»¶
   - åŒ…å«å®Œæ•´çš„ application å±‚ï¼ˆä¸šåŠ¡ä»£ç ï¼‰
   - ç”Ÿæˆåˆ é™¤åˆ—è¡¨ï¼ˆå¤šä½™çš„ä¾èµ–ï¼‰
5. **åˆ›å»ºåº”ç”¨è„šæœ¬**ï¼šç”Ÿæˆ `apply-diff.sh` è‡ªåŠ¨åŒ–åº”ç”¨è„šæœ¬

### è¾“å‡ºç»“æ„
```
script/diff/
â””â”€â”€ diff-package-20250918-094857.tar.gz
    â””â”€â”€ diff-package-20250918-094857/
        â”œâ”€â”€ apply-diff.sh              # è‡ªåŠ¨åº”ç”¨è„šæœ¬
        â””â”€â”€ modules/
            â”œâ”€â”€ web-system-8081/
            â”‚   â”œâ”€â”€ application/       # ä¸šåŠ¡ä»£ç å±‚
            â”‚   â”œâ”€â”€ files/            # æ–°å¢çš„jaræ–‡ä»¶
            â”‚   â”‚   â”œâ”€â”€ spring-boot-starter-web-3.2.1.jar
            â”‚   â”‚   â””â”€â”€ ...
            â”‚   â””â”€â”€ delete-list.txt   # éœ€è¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
            â””â”€â”€ web-file-8082/
                â””â”€â”€ ...
```

### ä½¿ç”¨ç¤ºä¾‹

#### 1. åŸºæœ¬ä½¿ç”¨æµç¨‹
```bash
# æ­¥éª¤1: è§£å‹ç°åœºæ”¶é›†çš„æ–‡ä»¶
tar -xzf script/collect/layers-collection-20250918-093742.tar.gz -C /tmp/

# æ­¥éª¤2: ç”Ÿæˆå·®å¼‚åŒ…
./script/compare-sync.sh --layers-collection /tmp/layers-collection-20250918-093742/

# æ­¥éª¤3: å°†ç”Ÿæˆçš„å·®å¼‚åŒ…å‘é€åˆ°ç°åœº
# script/diff/diff-package-20250918-094857.tar.gz
```

#### 2. æŒ‡å®šç‰¹å®šæ¨¡å—
```bash
./script/compare-sync.sh \
  --layers-collection /tmp/layers-collection-20250918-093742/ \
  --modules web-system-8081,gateway-9527
```

#### 3. åŒ…å«å¯é€‰æ ‡å¿—
```bash
./script/compare-sync.sh \
  --layers-collection /tmp/layers-collection-20250918-093742/ \
  --spring-boot-upgraded \
  --has-snapshot
```

### æ‰§è¡Œç¤ºä¾‹
```bash
$ ./script/compare-sync.sh --layers-collection /tmp/layers-collection-20250918-093742/

ğŸš€ å¼€å§‹ç”Ÿæˆå·®å¼‚åŒ…
ğŸ“˜ æ”¶é›†ç›®å½•: /tmp/layers-collection-20250918-093742/
ğŸ“˜ ä¸´æ—¶ç›®å½•: /path/to/script/diff-package-20250918-094857
ğŸ“˜ å·®å¼‚åŒ…ç›®å½•: /path/to/script/diff

ğŸš€ å‘ç°æ”¶é›†çš„æ¨¡å—
âœ… å‘ç°æ¨¡å—: web-system-8081
âœ… å‘ç°æ¨¡å—: web-file-8082
âœ… å‘ç°æ¨¡å—: gateway-9527

ğŸš€ å¼€å§‹å¤„ç†æ¨¡å—å·®å¼‚

ğŸš€ å¤„ç†æ¨¡å—: web-system-8081
ğŸ“˜ æ¨¡å— web-system-8081: å‘ç° layers.idx å·®å¼‚
ğŸ“˜ å·®å¼‚: +5 -2
[DEP] å®Œæˆï¼Œå¤åˆ¶ 5 ä¸ª jar

ğŸš€ å¤„ç†æ¨¡å—: web-file-8082
âœ… æ¨¡å— web-file-8082: layers.idx ä¸€è‡´ï¼Œä½†ä»éœ€æ›´æ–° application å±‚

ğŸš€ åˆ›å»ºå‹ç¼©åŒ…
âœ… å·²åˆ›å»ºå·®å¼‚åŒ…: diff-package-20250918-094857.tar.gz
ğŸ“˜ æ–‡ä»¶å¤§å°: 125M

ğŸš€ ç”Ÿæˆå®Œæˆ
ğŸ“˜ å·®å¼‚åŒ…ä½ç½®: script/diff/diff-package-20250918-094857.tar.gz
ğŸ“˜ å¤„ç†æ¨¡å—æ•°: 3
ğŸ“˜ åŒ…å«æ¨¡å—: web-system-8081 web-file-8082 gateway-9527
âœ… è¯·å°†å·®å¼‚åŒ…å‘é€ç»™ç°åœºæ‰§è¡Œ
```

---

## ç°åœºåº”ç”¨å·®å¼‚åŒ…

### åº”ç”¨æ­¥éª¤
1. **æ¥æ”¶å·®å¼‚åŒ…**ï¼šä»å¼€å‘ç¯å¢ƒè·å– `diff-package-*.tar.gz`
2. **è§£å‹å·®å¼‚åŒ…**ï¼š
   ```bash
   tar -xzf diff-package-20250918-094857.tar.gz
   cd diff-package-20250918-094857/
   ```
3. **æ‰§è¡Œåº”ç”¨è„šæœ¬**ï¼š
   ```bash
   ./apply-diff.sh
   ```

### apply-diff.sh åŠŸèƒ½
- **è‡ªåŠ¨å®šä½é¡¹ç›®**ï¼šå‘ä¸ŠæŸ¥æ‰¾åŒ…å« `docker/output` çš„é¡¹ç›®æ ¹ç›®å½•
- **å¤„ç†æ¯ä¸ªæ¨¡å—**ï¼š
  - åˆ é™¤å¤šä½™çš„ä¾èµ–æ–‡ä»¶
  - å¤åˆ¶æ–°å¢çš„jaræ–‡ä»¶åˆ°å¯¹åº”ç›®å½•
  - æ›´æ–° application å±‚ï¼ˆä¸šåŠ¡ä»£ç ï¼‰
- **æ™ºèƒ½åˆ†ç±»**ï¼šæ ¹æ®jaræ–‡ä»¶åè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä¸ºSNAPSHOTç‰ˆæœ¬

---

## æœ€ä½³å®è·µ

### 1. ç‰ˆæœ¬æ§åˆ¶
- ä¿ç•™æ”¶é›†åŒ…å’Œå·®å¼‚åŒ…ï¼Œä¾¿äºé—®é¢˜è¿½æº¯
- å»ºè®®æŒ‰æ—¶é—´æˆ³å‘½åï¼Œé¿å…æ–‡ä»¶è¦†ç›–

### 2. å®‰å…¨è€ƒè™‘
- ç°åœºæ”¶é›†å‰å…ˆå¤‡ä»½é‡è¦æ•°æ®
- å·®å¼‚åº”ç”¨å‰æµ‹è¯• `apply-diff.sh` è„šæœ¬æƒé™

### 3. æ€§èƒ½ä¼˜åŒ–
- å¯¹äºå¤§å‹é¡¹ç›®ï¼Œå¯ä½¿ç”¨ `--modules` å‚æ•°åªå¤„ç†å˜æ›´çš„æ¨¡å—
- ç½‘ç»œä¼ è¾“æ—¶å‹ç¼©å·®å¼‚åŒ…ä»¥å‡å°‘ä¼ è¾“æ—¶é—´

### 4. æ•…éšœæ’é™¤
- æ£€æŸ¥é¡¹ç›®ç›®å½•ç»“æ„æ˜¯å¦ç¬¦åˆé¢„æœŸ
- ç¡®è®¤ `docker/output/server` ç›®å½•ä¸‹æœ‰å¯¹åº”çš„æ¨¡å—
- éªŒè¯ `layers.idx` æ–‡ä»¶æ ¼å¼æ­£ç¡®

---

## ç›®å½•ç»“æ„è¦æ±‚

```
sol-cloud/
â”œâ”€â”€ docker/
â”‚   â””â”€â”€ output/
â”‚       â”œâ”€â”€ server/                    # æœåŠ¡ç«¯æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ web-system-8081/
â”‚       â”‚   â”‚   â”œâ”€â”€ application/       # ä¸šåŠ¡ä»£ç å±‚
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ BOOT-INF/
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ layers.idx
â”‚       â”‚   â”‚   â”œâ”€â”€ dependencies/      # æ™®é€šä¾èµ–å±‚
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ BOOT-INF/lib/
â”‚       â”‚   â”‚   â””â”€â”€ snapshot-dependencies/ # SNAPSHOTä¾èµ–å±‚
â”‚       â”‚   â”‚       â””â”€â”€ BOOT-INF/lib/
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ client/                    # å®¢æˆ·ç«¯æ¨¡å—ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ script/
    â”œâ”€â”€ collect-layers.sh
    â”œâ”€â”€ compare-sync.sh
    â”œâ”€â”€ collect/                       # æ”¶é›†åŒ…è¾“å‡ºç›®å½•
    â””â”€â”€ diff/                         # å·®å¼‚åŒ…è¾“å‡ºç›®å½•
```

---

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

1. **æœªå‘ç°ä»»ä½•æ¨¡å—**
   ```
   âŒ æœªå‘ç°ä»»ä½•æ¨¡å—çš„ layers.idx æ–‡ä»¶
   ```
   - æ£€æŸ¥ `docker/output/server` ç›®å½•æ˜¯å¦å­˜åœ¨
   - ç¡®è®¤æ¨¡å—ç›®å½•ç»“æ„æ­£ç¡®


2. **æ”¶é›†ç›®å½•ä¸å­˜åœ¨**
   ```
   âŒ æ”¶é›†ç›®å½•ä¸å­˜åœ¨: /path/to/collection
   ```
   - æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤å·²æ­£ç¡®è§£å‹æ”¶é›†åŒ…


3. **æ— æ³•æ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•**
   ```
   âŒ æ— æ³•æ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼ˆåŒ…å«docker/outputçš„ç›®å½•ï¼‰
   ```
   - ç¡®è®¤åœ¨æ­£ç¡®çš„é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œè„šæœ¬
   - æ£€æŸ¥é¡¹ç›®ç»“æ„æ˜¯å¦å®Œæ•´

---

